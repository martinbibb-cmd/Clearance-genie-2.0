<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clearance Genie AI - Intelligent Clearance Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Equipment Type Selection */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .equipment-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
        }

        .equipment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .equipment-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .equipment-card .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .equipment-card .label {
            font-size: 20px;
            font-weight: 600;
        }

        .equipment-card .description {
            font-size: 13px;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* Photo Upload */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area .icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        input[type="file"] {
            display: none;
        }

        /* Canvas */
        .canvas-container {
            position: relative;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Instructions */
        .instructions {
            background: #e8f4f8;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.6;
        }

        .instructions strong {
            color: #667eea;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Detected Objects List */
        .objects-list {
            margin: 20px 0;
        }

        .object-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .object-item .info {
            flex: 1;
        }

        .object-item .name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .object-item .clearance {
            font-size: 13px;
            color: #7f8c8d;
        }

        .object-item .toggle {
            margin-left: 10px;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            margin-right: 10px;
            border: 2px solid #333;
        }

        /* Result */
        .result {
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin: 20px 0;
        }

        .result.compliant {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .result.non-compliant {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .result .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .violations {
            background: white;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
            font-size: 14px;
        }

        .violations li {
            margin: 8px 0;
        }

        /* Draggable Equipment */
        .draggable-equipment {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: move;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .equipment-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Clearance Genie AI</h1>
            <div class="subtitle">Intelligent Clearance Checking with AI Object Detection</div>
        </div>

        <!-- Step 1: Equipment Type Selection -->
        <div class="card" id="step1">
            <h2>Step 1: Select Equipment Type</h2>
            <div class="instructions">
                <strong>Choose what you're checking:</strong> Select the equipment type to analyze clearance requirements.
            </div>
            <div class="equipment-grid">
                <div class="equipment-card" data-type="flue" onclick="selectEquipment('flue')">
                    <div class="icon">üå¨Ô∏è</div>
                    <div class="label">Flue Terminal</div>
                    <div class="description">External clearances to windows, vents, doors</div>
                </div>
                <div class="equipment-card" data-type="boiler" onclick="selectEquipment('boiler')">
                    <div class="icon">üî•</div>
                    <div class="label">Boiler</div>
                    <div class="description">Service clearances to walls, cupboards</div>
                </div>
                <div class="equipment-card" data-type="radiator" onclick="selectEquipment('radiator')">
                    <div class="icon">‚ô®Ô∏è</div>
                    <div class="label">Radiator</div>
                    <div class="description">Clearances to windows, curtains, furniture</div>
                </div>
                <div class="equipment-card" data-type="cylinder" onclick="selectEquipment('cylinder')">
                    <div class="icon">üõ¢Ô∏è</div>
                    <div class="label">Cylinder</div>
                    <div class="description">Service access to doors, shelves, valves</div>
                </div>
            </div>
            <button class="btn" id="continueToPhoto" disabled onclick="goToStep(2)">Continue to Photo Upload</button>
        </div>

        <!-- Step 2: Photo Upload -->
        <div class="card hidden" id="step2">
            <h2>Step 2: Upload Photo</h2>
            <div class="instructions">
                <strong>Important:</strong> Include a blue card or plumb line (400mm) in your photo for accurate calibration.
            </div>
            <div class="upload-area" onclick="document.getElementById('cameraInput').click()">
                <div class="icon">üì∏</div>
                <div><strong>Take Photo with Camera</strong></div>
                <div style="font-size: 14px; margin-top: 10px; color: #7f8c8d;">Include blue calibration card (400mm)</div>
            </div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment">
            <div class="upload-area" onclick="document.getElementById('uploadInput').click()">
                <div class="icon">üìÅ</div>
                <div><strong>Upload Existing Photo</strong></div>
                <div style="font-size: 14px; margin-top: 10px; color: #7f8c8d;">Select from device storage</div>
            </div>
            <input type="file" id="uploadInput" accept="image/*">
            <button class="btn btn-secondary" onclick="goToStep(1)">Back to Equipment Selection</button>
        </div>

        <!-- Step 3: Processing & Calibration -->
        <div class="card hidden" id="step3">
            <h2>Step 3: AI Processing & Calibration</h2>
            <div class="loading">
                <div class="spinner"></div>
                <div id="processingMessage">Analyzing photo with AI...</div>
            </div>
        </div>

        <!-- Step 4: Review Detected Objects -->
        <div class="card hidden" id="step4">
            <h2>Step 4: Review Detected Objects</h2>
            <div class="instructions">
                <strong>AI detected the following objects.</strong> Toggle any incorrect detections off.
            </div>
            <div class="canvas-container">
                <canvas id="detectionCanvas"></canvas>
            </div>
            <div class="objects-list" id="detectedObjectsList"></div>
            <button class="btn" onclick="goToStep(5)">Continue to Placement</button>
            <button class="btn btn-secondary" onclick="goToStep(2)">Retake Photo</button>
        </div>

        <!-- Step 5: Place Equipment -->
        <div class="card hidden" id="step5">
            <h2>Step 5: Place Your Equipment</h2>
            <div class="instructions">
                <strong>Drag and drop</strong> the equipment icon to its position in the photo. Clearance zones will update in real-time.
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(76, 175, 80, 0.3);"></div>
                    <span>Safe - Service Clearance OK</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(255, 193, 7, 0.3);"></div>
                    <span>Warning - Close to Object</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(244, 67, 54, 0.3);"></div>
                    <span>Violation - Too Close</span>
                </div>
            </div>
            <div class="canvas-container" id="placementCanvasContainer">
                <canvas id="placementCanvas"></canvas>
            </div>
            <button class="btn btn-success" onclick="confirmPlacement()">Confirm Placement</button>
            <button class="btn btn-secondary" onclick="goToStep(4)">Back to Review</button>
        </div>

        <!-- Step 6: Results -->
        <div class="card hidden" id="step6">
            <h2>Step 6: Clearance Check Results</h2>
            <div class="canvas-container">
                <canvas id="resultCanvas"></canvas>
            </div>
            <div id="resultSummary"></div>
            <button class="btn btn-success" onclick="downloadResult()">Download Annotated Photo</button>
            <button class="btn btn-secondary" onclick="startOver()">Start New Check</button>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            equipmentType: null,
            photo: null,
            photoWidth: 0,
            photoHeight: 0,
            scale: {
                pixelsPerMM: 0,
                calibrationComplete: false
            },
            detectedObjects: [],
            equipmentPosition: null,
            currentStep: 1
        };

        // Equipment Configurations
        const EQUIPMENT_CONFIG = {
            flue: {
                name: 'Flue Terminal',
                icon: 'üå¨Ô∏è',
                detectObjects: ['window', 'opening_window', 'air_vent', 'fan_vent', 'door', 'soil_pipe', 'downpipe'],
                clearances: {
                    opening_window: 300,
                    window: 150,
                    air_vent: 300,
                    fan_vent: 300,
                    door: 300,
                    soil_pipe: 300,
                    downpipe: 300
                },
                isInternal: false
            },
            boiler: {
                name: 'Boiler',
                icon: 'üî•',
                detectObjects: ['plug_socket', 'window', 'cupboard', 'shelf', 'wall', 'door'],
                clearances: {
                    plug_socket: 150,
                    window: 100,
                    cupboard: 50,
                    shelf: 300,
                    wall: 50,
                    door: 500
                },
                isInternal: true
            },
            radiator: {
                name: 'Radiator',
                icon: '‚ô®Ô∏è',
                detectObjects: ['plug', 'window', 'curtain', 'furniture', 'wall'],
                clearances: {
                    plug: 150,
                    window: 50,
                    curtain: 100,
                    furniture: 150,
                    wall: 50
                },
                isInternal: true
            },
            cylinder: {
                name: 'Cylinder',
                icon: 'üõ¢Ô∏è',
                detectObjects: ['door', 'shelf', 'pump', 'valve', 'wall', 'ceiling'],
                clearances: {
                    door: 400,
                    shelf: 150,
                    pump: 200,
                    valve: 300,
                    wall: 150,
                    ceiling: 450
                },
                isInternal: true
            }
        };

        // Step 1: Equipment Selection
        function selectEquipment(type) {
            state.equipmentType = type;

            // Update UI
            document.querySelectorAll('.equipment-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');

            document.getElementById('continueToPhoto').disabled = false;
        }

        // Navigation
        function goToStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }

            // Show target step
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
            state.currentStep = stepNumber;
        }

        // Step 2: Photo Upload Handlers
        document.getElementById('cameraInput').addEventListener('change', handlePhotoUpload);
        document.getElementById('uploadInput').addEventListener('change', handlePhotoUpload);

        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    state.photo = img;
                    state.photoWidth = img.width;
                    state.photoHeight = img.height;

                    // Move to processing step
                    goToStep(3);
                    processPhoto();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Step 3: Process Photo with AI
        async function processPhoto() {
            try {
                // Update processing message
                document.getElementById('processingMessage').textContent = 'Detecting blue calibration card...';

                // Detect and calibrate with blue card (400mm)
                await detectBlueCard();

                document.getElementById('processingMessage').textContent = 'Detecting objects with AI...';

                // Detect objects using Cloudflare Worker
                await detectObjects();

                // Move to review step
                goToStep(4);
                drawDetectedObjects();
            } catch (error) {
                console.error('Processing error:', error);
                alert('Error processing photo: ' + error.message);
                goToStep(2);
            }
        }

        // Detect Blue Card for Calibration
        async function detectBlueCard() {
            return new Promise((resolve) => {
                // Create temporary canvas for blue card detection
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = state.photoWidth;
                canvas.height = state.photoHeight;
                ctx.drawImage(state.photo, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                // Simple blue color detection
                let bluePixels = [];
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    // Check if pixel is blue (b > r && b > g)
                    if (b > r + 30 && b > g + 30 && b > 100) {
                        const x = (i / 4) % canvas.width;
                        const y = Math.floor((i / 4) / canvas.width);
                        bluePixels.push({ x, y });
                    }
                }

                if (bluePixels.length > 100) {
                    // Calculate bounding box of blue pixels
                    const xs = bluePixels.map(p => p.x);
                    const ys = bluePixels.map(p => p.y);
                    const minX = Math.min(...xs);
                    const maxX = Math.max(...xs);
                    const minY = Math.min(...ys);
                    const maxY = Math.max(...ys);

                    // Assume the longest dimension is 400mm
                    const widthPx = maxX - minX;
                    const heightPx = maxY - minY;
                    const longestDimension = Math.max(widthPx, heightPx);

                    state.scale.pixelsPerMM = longestDimension / 400;
                    state.scale.calibrationComplete = true;

                    console.log(`Calibration: ${state.scale.pixelsPerMM} pixels per mm`);
                } else {
                    // Fallback: use default calibration
                    console.warn('Blue card not detected, using default calibration');
                    state.scale.pixelsPerMM = state.photoWidth / 2000; // Assume ~2000mm width
                    state.scale.calibrationComplete = true;
                }

                setTimeout(resolve, 500);
            });
        }

        // Detect Objects using Cloudflare Worker
        async function detectObjects() {
            const config = EQUIPMENT_CONFIG[state.equipmentType];

            // Convert image to base64
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = state.photoWidth;
            canvas.height = state.photoHeight;
            ctx.drawImage(state.photo, 0, 0);
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);

            try {
                const response = await fetch('https://clearance-genie-worker.martinbibb.workers.dev', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageBase64,
                        equipmentType: state.equipmentType,
                        detectObjects: config.detectObjects
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const result = await response.json();
                state.detectedObjects = result.objects || [];

            } catch (error) {
                console.error('AI Detection Error:', error);

                // Fallback: Use mock data for demonstration
                state.detectedObjects = generateMockDetections();
            }
        }

        // Generate Mock Detections (fallback)
        function generateMockDetections() {
            const config = EQUIPMENT_CONFIG[state.equipmentType];
            const mockObjects = [];

            // Generate random mock detections based on equipment type
            const objectTypes = config.detectObjects;
            const numObjects = Math.floor(Math.random() * 3) + 2; // 2-4 objects

            for (let i = 0; i < numObjects && i < objectTypes.length; i++) {
                const type = objectTypes[i];
                mockObjects.push({
                    type: type,
                    label: type.replace(/_/g, ' ').toUpperCase(),
                    bounds: {
                        x: Math.random() * (state.photoWidth * 0.6) + (state.photoWidth * 0.1),
                        y: Math.random() * (state.photoHeight * 0.6) + (state.photoHeight * 0.1),
                        width: Math.random() * 200 + 100,
                        height: Math.random() * 200 + 100
                    },
                    confidence: Math.random() * 0.3 + 0.7,
                    enabled: true
                });
            }

            return mockObjects;
        }

        // Step 4: Draw Detected Objects
        function drawDetectedObjects() {
            const canvas = document.getElementById('detectionCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = state.photoWidth;
            canvas.height = state.photoHeight;

            // Draw photo
            ctx.drawImage(state.photo, 0, 0);

            // Draw detected objects
            state.detectedObjects.forEach((obj, index) => {
                if (!obj.enabled) return;

                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.strokeRect(obj.bounds.x, obj.bounds.y, obj.bounds.width, obj.bounds.height);

                // Label
                ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                ctx.fillRect(obj.bounds.x, obj.bounds.y - 25, 150, 25);
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`${obj.label} (${Math.round(obj.confidence * 100)}%)`, obj.bounds.x + 5, obj.bounds.y - 7);
            });

            // Update objects list
            updateObjectsList();
        }

        function updateObjectsList() {
            const list = document.getElementById('detectedObjectsList');
            const config = EQUIPMENT_CONFIG[state.equipmentType];

            list.innerHTML = '<h3 style="margin-bottom: 15px;">Detected Objects:</h3>';

            state.detectedObjects.forEach((obj, index) => {
                const clearance = config.clearances[obj.type] || 100;
                const item = document.createElement('div');
                item.className = 'object-item';
                item.innerHTML = `
                    <div class="info">
                        <div class="name">${obj.label}</div>
                        <div class="clearance">Required clearance: ${clearance}mm</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${obj.enabled ? 'checked' : ''}
                               onchange="toggleObject(${index})">
                        <span style="margin-left: 8px;">Include</span>
                    </label>
                `;
                list.appendChild(item);
            });
        }

        function toggleObject(index) {
            state.detectedObjects[index].enabled = !state.detectedObjects[index].enabled;
            drawDetectedObjects();
        }

        // Step 5: Place Equipment
        function goToStep5() {
            goToStep(5);
            setupPlacementCanvas();
        }

        function setupPlacementCanvas() {
            const canvas = document.getElementById('placementCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = state.photoWidth;
            canvas.height = state.photoHeight;

            // Set initial equipment position (center)
            if (!state.equipmentPosition) {
                state.equipmentPosition = {
                    x: state.photoWidth / 2,
                    y: state.photoHeight / 2
                };
            }

            drawPlacementScene();
            setupDragging(canvas);
        }

        function drawPlacementScene() {
            const canvas = document.getElementById('placementCanvas');
            const ctx = canvas.getContext('2d');
            const config = EQUIPMENT_CONFIG[state.equipmentType];

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw photo
            ctx.drawImage(state.photo, 0, 0);

            // Draw clearance zones around detected objects
            const violations = [];
            state.detectedObjects.forEach(obj => {
                if (!obj.enabled) return;

                const clearanceMM = config.clearances[obj.type] || 100;
                const clearancePx = clearanceMM * state.scale.pixelsPerMM;

                // Calculate if equipment overlaps with clearance zone
                const isOverlapping = checkOverlap(state.equipmentPosition, {
                    x: obj.bounds.x - clearancePx,
                    y: obj.bounds.y - clearancePx,
                    width: obj.bounds.width + (2 * clearancePx),
                    height: obj.bounds.height + (2 * clearancePx)
                });

                // Draw clearance zone
                ctx.fillStyle = isOverlapping ?
                    'rgba(244, 67, 54, 0.3)' :  // Red if overlapping
                    'rgba(76, 175, 80, 0.3)';   // Green if safe

                ctx.fillRect(
                    obj.bounds.x - clearancePx,
                    obj.bounds.y - clearancePx,
                    obj.bounds.width + (2 * clearancePx),
                    obj.bounds.height + (2 * clearancePx)
                );

                // Draw object box
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.strokeRect(obj.bounds.x, obj.bounds.y, obj.bounds.width, obj.bounds.height);

                if (isOverlapping) {
                    violations.push(obj);
                }
            });

            // Draw equipment position
            const equipRadius = 30;
            ctx.fillStyle = config.isInternal ?
                (violations.length > 0 ? 'rgba(244, 67, 54, 0.9)' : 'rgba(255, 255, 255, 0.9)') :
                (violations.length > 0 ? '#f44336' : '#4caf50');

            ctx.beginPath();
            ctx.arc(state.equipmentPosition.x, state.equipmentPosition.y, equipRadius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = violations.length > 0 ? '#c62828' : '#2e7d32';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Draw equipment icon
            ctx.font = '30px Arial';
            ctx.fillStyle = config.isInternal && violations.length === 0 ? '#000' : '#fff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(config.icon, state.equipmentPosition.x, state.equipmentPosition.y);

            // Store violations for later
            state.violations = violations;
        }

        function checkOverlap(point, rect) {
            return point.x >= rect.x &&
                   point.x <= rect.x + rect.width &&
                   point.y >= rect.y &&
                   point.y <= rect.y + rect.height;
        }

        function setupDragging(canvas) {
            let isDragging = false;

            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            canvas.addEventListener('mousedown', (e) => {
                const coords = getCoords(e);
                const dist = Math.sqrt(
                    Math.pow(coords.x - state.equipmentPosition.x, 2) +
                    Math.pow(coords.y - state.equipmentPosition.y, 2)
                );
                if (dist < 40) isDragging = true;
            });

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const coords = getCoords(e);
                const dist = Math.sqrt(
                    Math.pow(coords.x - state.equipmentPosition.x, 2) +
                    Math.pow(coords.y - state.equipmentPosition.y, 2)
                );
                if (dist < 40) isDragging = true;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                state.equipmentPosition = getCoords(e);
                drawPlacementScene();
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDragging) return;
                state.equipmentPosition = getCoords(e);
                drawPlacementScene();
            });

            canvas.addEventListener('mouseup', () => isDragging = false);
            canvas.addEventListener('touchend', () => isDragging = false);
            canvas.addEventListener('mouseleave', () => isDragging = false);
        }

        // Step 6: Confirm Placement
        function confirmPlacement() {
            goToStep(6);
            drawFinalResult();
        }

        function drawFinalResult() {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const config = EQUIPMENT_CONFIG[state.equipmentType];

            canvas.width = state.photoWidth;
            canvas.height = state.photoHeight;

            // Draw the placement scene
            ctx.drawImage(document.getElementById('placementCanvas'), 0, 0);

            // Generate result summary
            const resultDiv = document.getElementById('resultSummary');
            const isCompliant = state.violations.length === 0;

            if (isCompliant) {
                resultDiv.innerHTML = `
                    <div class="result compliant">
                        <div class="icon">‚úÖ</div>
                        <div>CLEARANCE COMPLIANT</div>
                        <div style="font-size: 16px; margin-top: 10px; opacity: 0.9;">
                            ${config.name} position meets all clearance requirements
                        </div>
                    </div>
                `;
            } else {
                const violationsList = state.violations.map(v =>
                    `<li>Too close to ${v.label} (requires ${config.clearances[v.type]}mm clearance)</li>`
                ).join('');

                resultDiv.innerHTML = `
                    <div class="result non-compliant">
                        <div class="icon">‚ö†Ô∏è</div>
                        <div>CLEARANCE VIOLATION</div>
                        <div class="violations">
                            <strong>Issues found:</strong>
                            <ul>${violationsList}</ul>
                        </div>
                    </div>
                `;
            }
        }

        function downloadResult() {
            const canvas = document.getElementById('resultCanvas');
            const link = document.createElement('a');
            link.download = `clearance-check-${state.equipmentType}-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function startOver() {
            location.reload();
        }

        // Initialize
        console.log('Clearance Genie AI initialized');
    </script>
</body>
</html>
